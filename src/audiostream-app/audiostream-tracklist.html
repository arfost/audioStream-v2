<link rel="import" href="../../bower_components/polymer/polymer-element.html">

<dom-module id="audiostream-tracklist">
  <template>
    <style>

    </style>
    <div>
      <h2>TrackList</h2>
      <div hidden$="[[_hideTrackList(error, loaded)]]">

        <template is="dom-repeat" items="{{trackList}}">
          <div>
            <span>{{item.artist}} {{item.title}}</span>
            <button on-click="_addTrack">play</button>
          </div>
        </template>

      </div>
      <div hidden$="[[!error]]">
        error
      </div>
      <div hidden$="[[loaded]]">
        loading
      </div>
    </div>
  </template>
  <script>
    /**
               * @customElement
               * @polymer
               */
    class AudiostreamTrackList extends Polymer.Element {
      static get is() { return 'audiostream-tracklist'; }
      static get properties() {
        return {
          error: {
            type: Boolean,
            value: false
          },
          loaded: {
            type: Boolean,
            value: false
          },
          trackList: {
            type: Array
          },
          trackRef: {
            type: Object
          },
          audioPlayer: {
            type: Object
          }
        };
      }

      //clever function to set the new track on the audio player
      //we have it here by binding from audiostream-app
      //and we directly set the values and launch it
      _addTrack(e){
        this.audioPlayer.play(e.model.item);
      }

      //to test if we have to hide the tracklist
      _hideTrackList(error, loaded){
        console.log("aff tracklist : ", !error && loaded)
        return !(!error && loaded)
      }


      //lifecycle method called when element is attached to dom
      //can be called multiple times
      connectedCallback() {
        super.connectedCallback();
        try {
          //get a firebase ref from a path
          this.trackRef = firebase.database().ref('/tracks');

          //attach listener to the ref, called each time event "value" is send from firebase
          //arrow function to bind the context (this) of the element in the callback
          this.trackRef.on('value', (snapshot)=>{
            //callback param (snapshot) and the way to use it (snapshot.val()) is in the firebase doc
            this.trackList = Object.values(snapshot.val());
            //we put loaded to true to show the tracklist
            this.loaded = true;
          });
        } catch (e) {
          console.log(e);
          this.error = true;
        }
      }

      //lifecycle method called when element is detached from dom
      //can be called multiple times
      detached(){
        super.detached();
        //detach all listeners on this ref
        this.trackRef.off();
      }
    }

    window.customElements.define(AudiostreamTrackList.is, AudiostreamTrackList);
  </script>
</dom-module>