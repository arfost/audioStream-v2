<link rel="import" href="../../bower_components/polymer/polymer-element.html">

<dom-module id="audiostream-tracklist">
  <template>
    <style>

    </style>
    <div>
      <h2>TrackList</h2>
      <div hidden$="[[_hideTrackList(error, loaded)]]">

        <template is="dom-repeat" items="{{trackList}}">
          <div>
            <span>{{item.artiste}} - {{item.title}}</span>
            <button on-click="_launchTrack">play</button>
          </div>
        </template>

      </div>
      <div hidden$="[[!error]]">
        error
      </div>
      <div hidden$="[[loaded]]">
        loading
      </div>
    </div>
  </template>
  <script>
    /**
               * @customElement
               * @polymer
               */
    class AudiostreamTrackList extends Polymer.Element {
      static get is() { return 'audiostream-tracklist'; }
      static get properties() {
        return {
          error: {
            type: Boolean,
            value: false
          },
          loaded: {
            type: Boolean,
            value: false
          },
          currentTrack: {
            type: Number,
            value: 0
          },
          trackList: {
            type: Array
          },
          trackRef: {
            type: Object
          },
          audioPlayer: {
            type: Object
          }
        };
      }

      _launchTrack(e) {
        console.log(e)
        this._pushTrackToAudioPlayer(e.model.item);
        this.currentTrack = e.model.index;
      }

      _pushTrackToAudioPlayer(track) {
        this.audioPlayer.play(track);
      }

      _nextTrack() {
        console.log("I'm getting it, nice isn't it ?")
        this.currentTrack++;
        this.audioPlayer.play(this.trackList[this.currentTrack])
      }

      _previousTrack() {
        console.log("I'm getting it, nice isn't it ?")
        this.currentTrack--;
        this.audioPlayer.play(this.trackList[this.currentTrack])
      }

      //to test if we have to hide the tracklist
      _hideTrackList(error, loaded) {
        console.log("aff tracklist : ", !error && loaded)
        return !(!error && loaded)
      }

      constructor() {
        super();
        this._boundNextTrack = this._nextTrack.bind(this);
        this._boundPreviousTrack = this._previousTrack.bind(this);
      }


      //lifecycle method called when element is attached to dom
      //can be called multiple times
      connectedCallback() {
        super.connectedCallback();
        try {
          //get a firebase ref from a path
          this.trackRef = firebase.database().ref('/tracks');

          //attach listener to the ref, called each time event "value" is send from firebase
          //arrow function to bind the context (this) of the element in the callback
          this.trackRef.on('value', (snapshot) => {
            //callback param (snapshot) and the way to use it (snapshot.val()) is in the firebase doc
            this.trackList = Object.values(snapshot.val());
            //we put loaded to true to show the tracklist
            this.loaded = true;
          });
          console.log(this.audioPlayer)
          this.audioPlayer.addEventListener('next', this._boundNextTrack)
          this.audioPlayer.addEventListener('previous', this._boundPreviousTrack)
        } catch (e) {
          console.log(e);
          this.error = true;
        }
      }

      //lifecycle method called when element is detached from dom
      //can be called multiple times
      disconnectedCallback() {
        super.disconnectedCallback();
        //detach all listeners on this ref
        this.trackRef.off();
        this.audioPlayer.removeEventListener('next', this._boundNextTrack)
        this.audioPlayer.removeEventListener('previous', this._boundPreviousTrack)
      }
    }

    window.customElements.define(AudiostreamTrackList.is, AudiostreamTrackList);
  </script>
</dom-module>